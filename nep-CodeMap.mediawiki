<pre>
  NEP: <to be assigned>
  Title: AVMMap
  Author: Sérgio Flores (@relfos), Ricardo Prado (@lock9), Alex  Fragapane(@afragapane), Alex DiCarlo(@dicarlo2), Li Jianying(@lightszero)
  Type: Standard
  Status: Draft
  Created: 2018-05-30
</pre>

==Abstract==

This NEP-X creates a standard source mapping file format, used to map NEOVM Opcodes(.avm) into high-level programming language source code.

该标准提出一个源码映射格式，用来定义 NEOVM 智能合约Opcodes(.AVM文件)应该如何对应到高级语言源代码.

==Motivation==

In order to increase smart-contract debugging support, we need a source mapping standard that is programming language agnostic.

NEO智能合约的调试已经产生了一些方案，但没有得到有效的推广，据此提出关于调试的map文件标准，可促进不同方案协同工作

==Specification==

The NEOVM source mapping file format is existing "Source Mapping revision 3(for web browser and javascript)", made by John Lenz (Google) and Nick Fitzgerald(Mozilla).

NEOVM源码映射文件格式使用的是“Source Mapping 第三版(用于web浏览器和javascript)”，该标准由google 和 mozilla 提出。

This reference can be found [https://docs.google.com/document/d/1U1RGAehQwRypUTovF1KRlpiOFze0b-_2gc6fAH0KY0k/preview#heading=h.1ce2c87bpj24 here].

====Terminology====

{|
! Term
! Definition
|-
| Generated Code
| The code which is generated by the compiler.
|-
| Original Source
| The source code which has not been passed through the compiler.
|-
| Base 64 VLQ
| The VLQ is a Base64 value, where the most significant bit (the 6th bit) is used as the continuation bit, and the “digits” are encoded into the string least significant first, and where the least significant bit of the first digit is used as the sign bit.
|-
| Source Mapping URL
| The URL referencing the location of a source map from the generated code.
|}


====File Format====
<pre>
{
"version" : 3,
"file": "out.js",
"sourceRoot": "",
"sources": ["foo.js", "bar.js"],
"sourcesContent": [null, null],
"names": ["src", "maps", "are", "fun"],
"mappings": "A,AAAB;;ABCDE;"
}
</pre>
<b>Line 1:</b> The entire file is a single JSON object
<br/>
<b>Line 2:</b> File version (always the first entry in the object) and must be a positive integer.
<br/>
<b>Line 3</b>: An optional name of the generated code that this source map is associated with.
<br/>
<b>Line 4:</b> An optional source root, useful for relocating source files on a server or removing repeated values in the “sources” entry.  This value is prepended to the individual entries in the “source” field.
<br/>
<b>Line 5:</b> A list of original sources used by the “mappings” entry.
<br/>
<b>Line 6:</b> An optional list of source content, useful when the “source” can’t be hosted. The contents are listed in the same order as the sources in line 5. “null” may be used if some original sources should be retrieved by name.
<br/>
<b>Line 7:</b> A list of symbol names used by the “mappings” entry.
</br>
<b>Line 8:</b> A string with the encoded mapping data.

The “mappings” data is broken down as follows:
#  Each group representing a line in the generated file is separated by a ”;”
#  Each segment is separated by a “,”
#  Each segment is made up of 1,4 or 5 variable length fields.
The fields in each segment are:
# The zero-based starting column of the line in the generated code that the segment represents. If this is the first field of the first segment, or the first segment following a new generated line (“;”), then this field holds the whole base 64 VLQ. Otherwise, this field contains a base 64 VLQ that is relative to the previous occurrence of this field. <i>Note that this is different than the fields below because the previous value is reset after every generated line.</i>
# If present, an zero-based index into the “sources” list. This field is a base 64 VLQ relative to the previous occurrence of this field, unless this is the first occurrence of this field, in which case the whole value is represented.
# If present, the zero-based starting line in the original source represented. This field is a base 64 VLQ relative to the previous occurrence of this field, unless this is the first occurrence of this field, in which case the whole value is represented. Always present if there is a source field.
# If present, the zero-based starting column of the line in the source represented. This field is a base 64 VLQ relative to the previous occurrence of this field, unless this is the first occurrence of this field, in which case the whole value is represented. Always present if there is a source field.
# If present, the zero-based index into the “names” list associated with this segment. This field is a base 64 VLQ relative to the previous occurrence of this field, unless this is the first occurrence of this field, in which case the whole value is represented.

====Resolving sources====

If the sources are not absolute URLs after prepending of the “sourceRoot”, the sources are resolved relative to the SourceMap (like resolving script src in a html document).

====Encoding====

the character set encoding for map file is always UTF-8.

==Rationale==

This design will significantly reduce the debug map files and creating a NEP will allow different programming languages to be used with NEO debuggers.
@relfos who is the original author of neo-debugger-tools, raised the need of a standard, since a standard file format would allow the debugger to work with different programming languages, and not only C# and Python. To help with this task, @ricklock9 contacted @afragapane and @dicarlo2 and their collaboration resulted in the use of the Source Mapping revision 3.

This subject was also presented to CoZ slack and neo-debugger-tools GitHub.


==Backwards Compatibility==

The new file format will have a .map.json ending.