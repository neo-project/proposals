<pre>
  NEP: <to be assigned>
  Title: P2P Protocol change
  Author: Shargon and Belane
  Type: Standard
  Status: Draft
  Created: 2018-03-07
</pre>

==Abstract==

We believe is necessary a P2P protocol optimization to avoid unnecessary data exchange, reducing the computational consumption, in order to improve and speed up communication between the nodes.

==Motivation==

Improve the P2P protocol to support higher loads, improve the communications speed and prioritize consensus messages. We think that is necessary to implement a compression mechanism and safe all bytes that should be possible

==Specification==

TODO

==Rationale==

TODO

==Backwards Compatibility==

TODO

==Test Cases==

TODO

==Implementation==

The current header includes a magic numbers of 4 bytes in all messages. 
This proposal try to change this header to 20 bytes only during the initial negotiation of the communication.

 +--------------------------+       +--------------------------------------------------------+
 |   Protocol negotiation   |  ...  |                    Message Protocol                    |  
 +--------------------------+       +--------------------------------------------------------+
 +------+ +-----------------+       +-------+ +---------+ +-----+ +--------------+ +---------+
 | UUID | | Version Message |  ...  | Flags | | Command | | CRC | | Payload Size | | Payload |
 +------+ +-----------------+       +-------+ +---------+ +-----+ +--------------+ +---------+

===Protocol negotiation (20 bytes)===

This is the first message sent, and is checked for continue or disconnect the client.

 +----------------------------+
 |    Protocol negotiation    |
 +----------------------------+
 +------+ +-------------------+
 | UUID | |                   |
 +------+ |  Version Message  |
 | 16 b | |                   |
 +------+ +-------------------+ 

* UUID - 16 bytes

We think that is better have a unique id (16 bytes) on the negotiation than an integer (4 bytes) on each message.

* Version Message

This field is a ''Message Protocol'' with the ''Command'' defined as ''version''. The payload attributed to this message is ''VersionPayload'' as defined [https://github.com/neo-project/neo/blob/master/neo/Network/Payloads/VersionPayload.cs here].

<pre>
Version Payload

Current version payload has Services field, we propose to change it to Enum Type and add SSL as possible value (0x02). With this value SSLStream will be used instead of NetworkStream.
</pre>

===Message Protocol===

Once this check is made, the communication flow begins as defined below.

 +--------------------------------------------------+
 |                 Message Protocol                 |  
 +--------------------------------------------------+
 +-------+ +---------+ +-----+ +--------+ +---------+
 | Flags | | Command | | CRC | |  Size  | | Payload |
 +-------+ +---------+ +-----+ +--------+ +---------+
 |  1b   | |    1b   | | 2b  | |   4b   | |         |
 +-------+ +---------+ +-----+ +--------+ | n bytes |
 |                   8b                 | |         |
 +--------------------------------------+ +---------+

* Message Flags - 1 byte

The availables MessageFlags are:
  
  - None = 0x00,
  - Compressed = 0x01
  - Urgent = 0x02

* Message Command - 1 byte

Currently the available commands are:
 
  - addr
  - alert
  - block
  - consensus
  - filteradd
  - filterclear
  - filterload
  - getaddr
  - getblocks
  - getdata
  - getheaders
  - headers
  - inv
  - mempool
  - merkleblock
  - ping
  - pong
  - reject
  - tx
  - verack
  - version

* Message CRC - 2 bytes

Message Checksum. Light CRC function instead of SHA256. [https://stackoverflow.com/questions/27939882/fast-crc-algorithm *]

* Payload Size - 4 bytes

Payload size. Integer (little-endian).

* Payload - n bytes

This field contains the message data.
